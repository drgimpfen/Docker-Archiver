{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-3">
    <div class="row">
        <div class="col-md-8">
            <div class="card recent-card">
                <div class="card-header">
                    <h5 class="mb-0">Recent Activity</h5>
                </div>
                <div class="card-body">
                    {% if recent_jobs %}
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Archive ID</th>
                                    <th>Stacks</th>
                                    <th>Started</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Size</th>
                                    <th>Duration</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for job in recent_jobs %}
                                    <tr>
                                        <td>#{{ job.archive_seq or '-' }}</td>
                                        <td>
                                            {% if job.stacks %}
                                                <div class="stack-badges">
                                                    {% for s in job.stacks %}
                                                        <span class="badge stack-badge" style="background-color: {{ s.color }}; color: {{ s.text_color }}">{{ s.name }}</span>
                                                    {% endfor %}
                                                </div>
                                            {% else %}
                                                <span class="text-muted">(no stacks)</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ job.started_str or 'N/A' }}</td>
                                        <td>{{ job.type|capitalize }}</td>
                                        <td>
                                            <span class="badge {% if job.status == 'Success' %} bg-success {% elif job.status == 'Failed' %} bg-danger {% elif job.status == 'Running' %} bg-info {% else %} bg-secondary {% endif %}">
                                                {{ job.status }}
                                            </span>
                                        </td>
                                        <td>{{ job.size_human or 'N/A' }}</td>
                                        <td>{{ job.duration_human or 'N/A' }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p class="text-center text-muted">No archives have been created yet.</p>
                    {% endif %}

                </div>
                <div class="card-action text-center py-3">
                    <a href="{{ url_for('history') }}" class="btn btn-outline-secondary btn-sm mx-auto">View Full History</a>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Retention</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6 class="mb-2">Recent Retention Runs</h6>
                        {% if retention_runs %}
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Trigger</th>
                                        <th>Start</th>
                                        <th>Status</th>
                                        <th>Duration</th>
                                        <th>Reclaimed</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for r in retention_runs %}
                                        <tr data-retention-id="{{ r.id }}">
                                            <td>{{ r.trigger }}</td>
                                            <td>{{ r.start_str or 'N/A' }}</td>
                                            <td>
                                                <span class="badge {% if r.status == 'Success' %} bg-success {% elif r.status == 'Failed' %} bg-danger {% else %} bg-secondary {% endif %}">
                                                    {{ r.status }}
                                                </span>
                                            </td>
                                            <td>{{ r.duration_human or 'N/A' }}</td>
                                            <td>{{ r.reclaimed_human or 'N/A' }}</td>
                                            <td>
                                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="showRetentionDetails({{ r.id }})">Details</button>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        {% else %}
                            <p class="text-muted">No recent retention runs.</p>
                        {% endif %}
                    </div>

                    <form method="post" action="{{ url_for('start_retention_route') }}">
                        <div class="mb-2">
                            <label for="description" class="form-label">Description (optional)</label>
                            <textarea id="description" name="description" class="form-control" rows="3">{{ default_cleanup_description }}</textarea>
                        </div>
                        <button type="submit" class="btn btn-primary" {% if cleanup_in_progress %} disabled {% endif %}>Run Retention Now</button>
                        {% if cleanup_in_progress %}
                            <small class="text-muted ms-2">A retention job is currently running.</small>
                        {% else %}
                            <small class="text-muted ms-2">Applies current retention settings to all stacks.</small>
                        {% endif %}
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
                <!-- Retention Details Modal -->
                <div class="modal fade" id="retentionModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-lg modal-dialog-scrollable">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Retention Details</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div id="retentionMeta" class="mb-3">
                                    <div><strong>ID:</strong> <span id="r-id"></span></div>
                                    <div><strong>Trigger:</strong> <span id="r-trigger"></span></div>
                                    <div><strong>Start:</strong> <span id="r-start"></span></div>
                                    <div><strong>End:</strong> <span id="r-end"></span></div>
                                    <div><strong>Status:</strong> <span id="r-status"></span></div>
                                    <div><strong>Duration:</strong> <span id="r-duration"></span></div>
                                    <div><strong>Reclaimed:</strong> <span id="r-reclaimed"></span></div>
                                    <div><strong>Description:</strong> <div id="r-desc"></div></div>
                                </div>

                                <h6>Deleted Files / Actions</h6>
                                <pre id="r-log" style="background:#f8f9fa;padding:8px;border-radius:6px;max-height:320px;overflow:auto;white-space:pre-wrap;"></pre>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>

                <script>
                function formatBytes(n){
                    if(n===null||n===undefined) return 'N/A';
                    var sizes=['B','KB','MB','GB','TB'];
                    if(n===0) return '0 B';
                    var i=Math.floor(Math.log(n)/Math.log(1024));
                    return (n/Math.pow(1024,i)).toFixed(1)+' '+sizes[i];
                }

                function showRetentionDetails(id){
                    fetch(`/retention/${id}`)
                        .then(r=>r.json())
                        .then(data=>{
                            if(data.error){ alert(data.error); return; }
                            document.getElementById('r-id').textContent = data.id;
                            document.getElementById('r-trigger').textContent = data.job_type ? (data.job_type=='manual'?'Manual':'Automatic') : 'N/A';
                            document.getElementById('r-start').textContent = data.start_time || 'N/A';
                            document.getElementById('r-end').textContent = data.end_time || 'N/A';
                            document.getElementById('r-status').textContent = data.status || 'N/A';
                            document.getElementById('r-duration').textContent = data.duration_seconds ? new Date(data.duration_seconds*1000).toISOString().substr(11,8) : 'N/A';
                            document.getElementById('r-reclaimed').textContent = data.reclaimed_bytes ? formatBytes(data.reclaimed_bytes) : 'N/A';
                            document.getElementById('r-desc').textContent = data.description || '';
                            document.getElementById('r-log').textContent = data.log || '';
                            var modalEl = document.getElementById('retentionModal');
                            var bsModal = new bootstrap.Modal(modalEl);
                            bsModal.show();
                        }).catch(e=>{ alert('Failed to fetch retention details: '+e); });
                }
                </script>
{% endblock %}
